# @title üìä Financial Analyst AI with Gemini 1.5 Flash (1M+ Context)
# @markdown Uses Google's Gemini 1.5 Flash - Massive context window reads ENTIRE 10-K!
# ============================================================================
# üîë PASTE YOUR GOOGLE AI STUDIO API KEY HERE
# Get one free at: https://aistudio.google.com/app/apikey
# ============================================================================
GEMINI_API_KEY = "xxxxx"  # <-- PASTE YOUR API KEY HERE
# ============================================================================
# Note: If running in Colab, you may need to install beautifulsoup4 and google-generativeai:
# !pip install beautifulsoup4 google-generativeai
import yfinance as yf
from IPython.display import display, Markdown
import requests
import json
from datetime import datetime
import google.generativeai as genai
import time
# ============================================================================
# SECTION 1: SEC EDGAR DATA FETCHER
# ============================================================================
class SECEdgarFetcher:
    """Fetches company filings from SEC EDGAR database"""

    def __init__(self, user_agent="Stock Analyzer research@example.com"):
        self.headers = {'User-Agent': user_agent}
        self.base_url = "https://data.sec.gov"

    def get_cik(self, ticker):
        """Convert ticker to CIK"""
        try:
            url = "https://www.sec.gov/files/company_tickers.json"
            response = requests.get(url, headers=self.headers, timeout=10)

            if response.status_code == 200:
                data = response.json()
                ticker_upper = ticker.upper()

                for entry in data.values():
                    if entry['ticker'] == ticker_upper:
                        return str(entry['cik_str']).zfill(10)
            return None
        except:
            return None

    def get_recent_filings(self, ticker, filing_types=['10-K', '10-Q', 'DEF 14A'], limit=10):
        """Get recent SEC filings with metadata"""
        cik = self.get_cik(ticker)
        if not cik:
            return None

        try:
            url = f"{self.base_url}/submissions/CIK{cik}.json"
            response = requests.get(url, headers=self.headers, timeout=10)

            if response.status_code != 200:
                return None

            data = response.json()
            filings = data.get('filings', {}).get('recent', {})

            results = []
            forms = filings.get('form', [])
            filing_dates = filings.get('filingDate', [])
            accession_numbers = filings.get('accessionNumber', [])
            primary_docs = filings.get('primaryDocument', [])

            for i, form in enumerate(forms):
                if form in filing_types and len(results) < limit:
                    accession = accession_numbers[i]
                    filing_url = f"https://www.sec.gov/cgi-bin/viewer?action=view&cik={cik}&accession_number={accession.replace('-', '')}&xbrl_type=v"
                    results.append({
                        'type': form,
                        'date': filing_dates[i],
                        'accession': accession,
                        'primary_doc': primary_docs[i] if i < len(primary_docs) else None,
                        'cik': cik,
                        'url': filing_url
                    })

            return results
        except:
            return None

    def get_filing_text(self, filing):
        """Fetch actual text content from a filing"""
        try:
            if not filing.get('primary_doc'):
                return None

            # Construct URL to the actual filing document (Raw Text)
            # URL format: https://www.sec.gov/Archives/edgar/data/{cik_no_zeros}/{accession_no_dashes}/{accession}.txt
            accession_no_dashes = filing['accession'].replace('-', '')
            accession = filing['accession']
            cik_int = int(filing['cik']) # Strip zeros

            url = f"https://www.sec.gov/Archives/edgar/data/{cik_int}/{accession_no_dashes}/{accession}.txt"

            # Add a specific header to avoid 403s on Archives
            headers = self.headers.copy()
            headers['Host'] = 'www.sec.gov'

            print(f"      ‚¨áÔ∏è  Downloading from: {url}")
            response = requests.get(url, headers=headers, timeout=20)

            if response.status_code == 200:
                return response.text

            return None
        except:
            return None

    def extract_key_sections(self, filing_text, filing_type='10-K', max_chars=600000, specific_section=None):
        """
        Extract specific section (like MD&A) or full text.
        max_chars: Default reduced to 600k (~150k tokens) to safely fit in 250k limit.
        specific_section: 'MD&A' or None (for full text)
        """
        if not filing_text:
            return None

        import re
        from bs4 import BeautifulSoup

        try:
            # Parse HTML
            soup = BeautifulSoup(filing_text, 'html.parser')
            text = soup.get_text(separator='\n', strip=True)
            text = re.sub(r'\n\s*\n', '\n\n', text)

            # If we want EVERYTHING (Current 10-K)
            if not specific_section:
                truncated_text = text[:max_chars]
                if len(truncated_text) >= len(text):
                    return {'FULL_FILING_TEXT': truncated_text}
                else:
                    print(f"      ‚ö†Ô∏è  Note: 10-K was truncated at {max_chars:,} chars (Total: {len(text):,}). This usually just cuts off exhibits.")
                    return {'FULL_FILING_TEXT': truncated_text}
            # If we only want MD&A (Previous 10-K to save context)
            if specific_section == 'MD&A':
                # 10-K patterns for MD&A (Item 7)
                mda_patterns = [
                    r'(?:ITEM\s*7|Item\s*7)[\.\ s]*(?:MANAGEMENT|Management).*?(?:DISCUSSION|Discussion)(.*?)(?:ITEM\s*7A|Item\s*7A|ITEM\s*8|Item\s*8)',
                    r'(?:ITEM\s*7|Item\s*7)[^\n]*(?:MD&A|DISCUSSION)(.*?)(?:ITEM\s*8|Item\s*8)',
                ]

                print("      üîç Searching for MD&A section...")
                for pattern in mda_patterns:
                    # Find all matches, not just the first (to skip TOCs)
                    matches = re.finditer(pattern, text, re.DOTALL | re.IGNORECASE)
                    for match in matches:
                        content = match.group(1).strip()
                        # Filtering out Table of Contents entries (too short)
                        if len(content) > 1000:
                            print(f"      ‚úÖ Found MD&A Section via regex ({len(content):,} chars)")
                            return {'FULL_FILING_TEXT': content[:max_chars]}
                        else:
                            print(f"      ‚ÑπÔ∏è  Skipped potential TOC match ({len(content)} chars)")

                # Fallback: simple text search if regex fails
                print("      ‚ö†Ô∏è  Regex MD&A search failed, using keyword search...")
                idx = text.lower().find("management's discussion")
                if idx != -1:
                    return {'FULL_FILING_TEXT': text[idx:idx+max_chars]}

                return {'FULL_FILING_TEXT': text[:max_chars]} # Ultimate fallback

            return {'FULL_FILING_TEXT': text[:max_chars]}
        except Exception as e:
            return {'FULL_FILING_TEXT': filing_text[:max_chars]}

    def get_company_facts(self, ticker):
        """Get structured financial data from SEC XBRL filings"""
        cik = self.get_cik(ticker)
        if not cik:
            return None

        try:
            # SEC Company Facts API provides structured XBRL data
            url = f"{self.base_url}/api/xbrl/companyfacts/CIK{cik}.json"
            response = requests.get(url, headers=self.headers, timeout=15)

            if response.status_code != 200:
                return None

            data = response.json()

            # Extract key financial metrics from US-GAAP taxonomy
            facts = data.get('facts', {}).get('us-gaap', {})

            if not facts:
                return None

            # Helper to get most recent annual value
            def get_recent_annual_value(fact_name):
                if fact_name not in facts:
                    return None

                units = facts[fact_name].get('units', {})
                # Try USD first, then shares
                for unit_type in ['USD', 'shares', 'pure']:
                    if unit_type in units:
                        values = units[unit_type]
                        # Filter for annual filings (10-K)
                        annual_values = [v for v in values if v.get('form') == '10-K']
                        if annual_values:
                            # Sort by filing date and get most recent
                            annual_values.sort(key=lambda x: x.get('filed', ''), reverse=True)
                            return annual_values[0].get('val')
                return None

            # Extract key metrics
            metrics = {}

            # Revenue metrics
            metrics['Revenue'] = get_recent_annual_value('Revenues') or get_recent_annual_value('RevenueFromContractWithCustomerExcludingAssessedTax')
            metrics['CostOfRevenue'] = get_recent_annual_value('CostOfRevenue')
            metrics['GrossProfit'] = get_recent_annual_value('GrossProfit')
            metrics['OperatingIncome'] = get_recent_annual_value('OperatingIncomeLoss')
            metrics['NetIncome'] = get_recent_annual_value('NetIncomeLoss')
            metrics['EPS'] = get_recent_annual_value('EarningsPerShareBasic')

            # Balance sheet
            metrics['TotalAssets'] = get_recent_annual_value('Assets')
            metrics['TotalLiabilities'] = get_recent_annual_value('Liabilities')
            metrics['StockholdersEquity'] = get_recent_annual_value('StockholdersEquity')
            metrics['Cash'] = get_recent_annual_value('CashAndCashEquivalentsAtCarryingValue')
            metrics['LongTermDebt'] = get_recent_annual_value('LongTermDebt')

            # Cash flow
            metrics['OperatingCashFlow'] = get_recent_annual_value('NetCashProvidedByUsedInOperatingActivities')
            metrics['CapitalExpenditures'] = get_recent_annual_value('PaymentsToAcquirePropertyPlantAndEquipment')
            metrics['FreeCashFlow'] = get_recent_annual_value('FreeCashFlow')

            # Filter out None values
            metrics = {k: v for k, v in metrics.items() if v is not None}

            if metrics:
                print(f"   ‚úÖ Extracted {len(metrics)} XBRL financial metrics:")
                for k, v in metrics.items():
                    # Format for display
                    val_str = f"${v/1e9:.2f}B" if abs(v) >= 1e9 else f"${v/1e6:.2f}M"
                    print(f"      - {k}: {val_str}")

            return metrics if metrics else None

        except Exception as e:
            return None
# ============================================================================
# SECTION 2: DATA FORMATTING
# ============================================================================
def format_currency(num):
    if num is None or num == 'N/A':
        return "N/A"
    try:
        val = float(num)
        if val >= 1e12:
            return f"${val/1e12:.2f}T"
        elif val >= 1e9:
            return f"${val/1e9:.2f}B"
        elif val >= 1e6:
            return f"${val/1e6:.2f}M"
        elif val >= 1e3:
            return f"${val/1e3:.2f}K"
        else:
            return f"${val:.2f}"
    except:
        return str(num)
def format_percent(num):
    if num is None or num == 'N/A':
        return "N/A"
    try:
        return f"{float(num)*100:.2f}%"
    except:
        return str(num)
def format_number(num):
    if num is None or num == 'N/A':
        return "N/A"
    try:
        return f"{float(num):,.0f}"
    except:
        return str(num)
# ============================================================================
# SECTION 3: DATA FETCHER
# ============================================================================
def get_comprehensive_data(ticker_symbol):
    """Fetch data from yfinance and SEC EDGAR"""
    print(f"\n{'='*60}")
    print(f"üìä Fetching data for {ticker_symbol}...")
    print(f"{'='*60}\n")

    # Yahoo Finance Data
    print("1Ô∏è‚É£  Fetching Yahoo Finance data...")
    try:
        stock = yf.Ticker(ticker_symbol)
        info = stock.info

        if 'currentPrice' not in info and 'regularMarketPrice' not in info:
            return None, "‚ùå Ticker not found."

        current_price = info.get('currentPrice') or info.get('regularMarketPrice', 0)

        # --- FIX DEBT/EQUITY RATIO ---
        # Yahoo Finance often reports D/E as a percentage
        # We calculate it manually to be safe, or normalize the reported value.
        total_debt = info.get('totalDebt', 0) or 0
        stockholders_equity = info.get('stockholdersEquity', 0) or 0
        reported_de = info.get('debtToEquity')

        de_ratio_str = "N/A"

        if total_debt > 0 and stockholders_equity > 0:
            # Calculate from raw numbers (most reliable)
            calc_ratio = total_debt / stockholders_equity
            de_ratio_str = f"{calc_ratio:.2f}x"
        elif reported_de is not None:
            # Fallback to reported, but normalize if > 10 (assume it's %)
            if reported_de > 10:
                de_ratio_str = f"{reported_de/100:.2f}x"
            else:
                de_ratio_str = f"{reported_de:.2f}x"

        profile = f"""
COMPANY: {info.get('longName', 'N/A')} ({ticker_symbol.upper()})
SECTOR: {info.get('sector', 'N/A')}
INDUSTRY: {info.get('industry', 'N/A')}
COUNTRY: {info.get('country', 'N/A')}
EMPLOYEES: {format_number(info.get('fullTimeEmployees'))}
BUSINESS SUMMARY:
{info.get('longBusinessSummary', 'N/A')[:1500]}
VALUATION & SIZE:
Current Price: {format_currency(current_price)}
Market Cap: {format_currency(info.get('marketCap'))}
Enterprise Value: {format_currency(info.get('enterpriseValue'))}
FINANCIAL PERFORMANCE:
Total Revenue (TTM): {format_currency(info.get('totalRevenue'))}
Revenue Growth: {format_percent(info.get('revenueGrowth'))}
Gross Profit: {format_currency(info.get('grossProfits'))}
EBITDA: {format_currency(info.get('ebitda'))}
Net Income: {format_currency(info.get('netIncomeToCommon'))}
MARGINS:
Gross Margin: {format_percent(info.get('grossMargins'))}
Operating Margin: {format_percent(info.get('operatingMargins'))}
Profit Margin: {format_percent(info.get('profitMargins'))}
VALUATION RATIOS:
P/E (Trailing): {info.get('trailingPE', 'N/A')}
P/E (Forward): {info.get('forwardPE', 'N/A')}
PEG Ratio: {info.get('pegRatio', 'N/A')}
Price/Sales: {info.get('priceToSalesTrailing12Months', 'N/A')}
Price/Book: {info.get('priceToBook', 'N/A')}
EV/EBITDA: {info.get('enterpriseToEbitda', 'N/A')}
RETURNS:
ROE: {format_percent(info.get('returnOnEquity'))}
ROA: {format_percent(info.get('returnOnAssets'))}
BALANCE SHEET:
Total Cash: {format_currency(info.get('totalCash'))}
Total Debt: {format_currency(info.get('totalDebt'))}
Net Debt: {format_currency((info.get('totalDebt', 0) or 0) - (info.get('totalCash', 0) or 0))}
Debt/Equity: {de_ratio_str}
Current Ratio: {info.get('currentRatio', 'N/A')}
CASH FLOW:
Operating Cash Flow: {format_currency(info.get('operatingCashflow'))}
Free Cash Flow: {format_currency(info.get('freeCashflow'))}
FCF Yield: {format_percent((info.get('freeCashflow', 0) or 0) / (info.get('marketCap', 1) or 1))}
DIVIDENDS:
Dividend Yield: {format_percent(info.get('dividendYield'))}
Payout Ratio: {format_percent(info.get('payoutRatio'))}
ANALYST COVERAGE:
Recommendation: {info.get('recommendationKey', 'N/A').upper()}
Target Price: {format_currency(info.get('targetMeanPrice'))}
Number of Analysts: {info.get('numberOfAnalystOpinions', 'N/A')}
"""

        # Add financial statements
        statements = ""
        try:
            inc = stock.financials
            if inc is not None and not inc.empty:
                statements += "\n=== INCOME STATEMENT (Recent Years) ===\n"
                for idx in inc.index[:10]:
                    row = inc.loc[idx].iloc[:2]
                    statements += f"{idx}: {', '.join([format_currency(v) for v in row])}\n"
        except:
            pass

        try:
            bal = stock.balance_sheet
            if bal is not None and not bal.empty:
                statements += "\n=== BALANCE SHEET (Recent Years) ===\n"
                for idx in bal.index[:10]:
                    row = bal.loc[idx].iloc[:2]
                    statements += f"{idx}: {', '.join([format_currency(v) for v in row])}\n"
        except:
            pass

        context = profile + statements
        print("   ‚úÖ Yahoo Finance data retrieved")

    except Exception as e:
        return None, f"‚ùå Error: {e}"

    # Data validation and cross-checking
    data_quality_notes = "\n\n=== DATA QUALITY NOTES ===\n"

    # Calculate debt-to-equity from raw numbers if available
    # (Already handled in profile creation, but keeping raw check for debug)
    if total_debt > 0 and stockholders_equity > 0:
        calculated_de_ratio = total_debt / stockholders_equity
        data_quality_notes += f"\nDebt-to-Equity Ratio (Calculated): {calculated_de_ratio:.2f}x\n"
        data_quality_notes += f"(derived from Total Debt {format_currency(total_debt)} / Equity {format_currency(stockholders_equity)})\n"

    # Check for unrealistic dividend yield
    div_yield = info.get('dividendYield', 0) or 0
    if div_yield > 0.20:  # More than 20% is suspicious
        data_quality_notes += f"‚ö†Ô∏è  DIVIDEND YIELD ANOMALY: {div_yield*100:.1f}% seems unrealistic. Verify this number.\n\n"

    context += data_quality_notes

    # SEC EDGAR Data
    print("\n2Ô∏è‚É£  Fetching SEC EDGAR filings...")
    try:
        sec = SECEdgarFetcher()
        # Fetch more filings to find previous 10-Ks
        all_filings = sec.get_recent_filings(ticker_symbol, limit=20)

        # Filter for 10-Ks
        ten_ks = [f for f in all_filings if f['type'] == '10-K'] if all_filings else []
        ten_qs = [f for f in all_filings if f['type'] == '10-Q'] if all_filings else []
        def_14as = [f for f in all_filings if f['type'] == 'DEF 14A'] if all_filings else []

        # Print all SEC filing links
        if all_filings:
            print(f"\n   *** SEC FILING LINKS ***")
            for filing in all_filings[:10]:  # Show first 10
                print(f"      {filing['type']} ({filing['date']})")
                print(f"      {filing['url']}")
                print()

        if ten_ks:
            edgar = "\n\n=== SEC EDGAR FILING ANALYSIS ===\n"

            # --- CURRENT 10-K ---
            latest_filing = ten_ks[0]
            edgar += f"\n--- CURRENT 10-K (Filed: {latest_filing['date']}) ---\n"
            edgar += f"View at: {latest_filing['url']}\n\n"

            print(f"   üìÑ Downloading Current 10-K ({latest_filing['date']})...")
            filing_text = sec.get_filing_text(latest_filing)

            if filing_text:
                print("   üìù Extracting FULL TEXT from Current 10-K (Gemini 1.5 Flash can handle it)...")
                # Reduced to 500k chars to fit 250k token limit
                sections = sec.extract_key_sections(filing_text, filing_type='10-K', max_chars=500000)

                if sections:
                    print(f"      ‚úÖ Extracted Full 10-K Text ({len(sections.get('FULL_FILING_TEXT', '')):,} chars)")
                    edgar += f"--- FULL 10-K TEXT (Current) ---\n{sections.get('FULL_FILING_TEXT', '')}\n\n"
                else:
                    edgar += "(Could not extract sections from Current 10-K)\n"

            # --- PREVIOUS 10-K (For Comparison) ---
            # --- PREVIOUS 10-K (For Comparison - MD&A ONLY) ---
            if len(ten_ks) > 1:
                prev_filing = ten_ks[1]
                print(f"   üìÑ Downloading Previous 10-K ({prev_filing['date']}) for comparison...")
                prev_text = sec.get_filing_text(prev_filing)

                if prev_text:
                    print("   üìù Extracting ONLY MD&A from Previous 10-K (to save tokens)...")
                    # Use tailored MD&A extraction with strict limit
                    prev_sections = sec.extract_key_sections(prev_text, filing_type='10-K', max_chars=100000, specific_section='MD&A')

                    if prev_sections:
                        print(f"      ‚úÖ Extracted Previous MD&A ({len(prev_sections.get('FULL_FILING_TEXT','')):,} chars)")
                        edgar += f"\n\n=== PREVIOUS YEAR 10-K (Filed: {prev_filing['date']}) ===\n"
                        edgar += "Use this data ONLY for the 'Year-over-Year Analysis' section.\n"
                        edgar += f"--- MD&A ONLY (Previous) ---\n{prev_sections.get('FULL_FILING_TEXT', '')}\n\n"
            else:
                print("   ‚ÑπÔ∏è  No previous 10-K found for comparison")
            # --- DEF 14A (Proxy Statement) for Compensation Analysis ---
            if def_14as:
                latest_proxy = def_14as[0]
                print(f"   üìÑ Downloading DEF 14A (Proxy) ({latest_proxy['date']}) for Compensation Analysis...")
                proxy_text = sec.get_filing_text(latest_proxy)
                if proxy_text:
                    print(f"   üìù Extracting Proxy Statement Text...")
                    # Cap at 250k chars to safeguard tokens
                    proxy_sections = sec.extract_key_sections(proxy_text, filing_type='DEF 14A', max_chars=250000)
                    if proxy_sections:
                        print(f"      ‚úÖ Extracted Proxy Text ({len(proxy_sections.get('FULL_FILING_TEXT', '')):,} chars)")
                        edgar += f"\n\n=== DEF 14A PROXY STATEMENT (Filed: {latest_proxy['date']}) ===\n"
                        edgar += "Use this for 'Executive Compensation & Incentives' section.\n"
                        edgar += f"--- FULL PROXY TEXT ---\n{proxy_sections.get('FULL_FILING_TEXT', '')}\n\n"
            else:
                 print("   ‚ÑπÔ∏è  No DEF 14A (Proxy) found")
            # --- LATEST 10-Q (For Narrative/Recent Updates) ---
            context += edgar
        else:
            print("   ‚ö†Ô∏è  No 10-K filings found")
    except Exception as e:
        print(f"   ‚ö†Ô∏è  SEC EDGAR error: {e}")
        pass

    # SEC Financial Facts (XBRL data)
    print("\n3Ô∏è‚É£  Fetching SEC EDGAR financial data (XBRL)...")
    try:
        sec = SECEdgarFetcher()
        financial_facts = sec.get_company_facts(ticker_symbol)

        if financial_facts:
            edgar_financials = "\n\n=== SEC EDGAR FINANCIAL DATA (from 10-K filings) ===\n"
            edgar_financials += "These are the official numbers from SEC filings:\n\n"

            # Format the financial data
            for metric, value in financial_facts.items():
                edgar_financials += f"{metric}: {format_currency(value)}\n"

            context += edgar_financials
            print(f"   ‚úÖ Retrieved {len(financial_facts)} financial metrics from SEC XBRL data")
        else:
            print("   ‚ö†Ô∏è  SEC financial data not available")
    except Exception as e:
        print(f"   ‚ö†Ô∏è  SEC financial data error: {e}")
        pass
    # Recent News
    print(f"\n‚úÖ Data collection complete!\n")
    return context, None
# ============================================================================
# SECTION 4: FRAMEWORK
# ============================================================================
FRAMEWORK = """
Analyze this company using the 13-point framework below.
**CRITICAL RULES**:
1. Use ONLY the factual data provided above
2. Read numbers EXACTLY as written (if it says "200B", write "200B")
3. Be analytical, precise, and concrete - no marketing language
4. If data is missing, state "Data not available"
5. **FORMATTING**: Do NOT use LaTeX math formatting (no $ signs). Use 'USD' suffix for currency (e.g., "500M USD").
**OUTPUT FORMAT** (use proper markdown):
## Executive Summary
Write 150-200 words summarizing how this company makes money, its economic quality, edge, and risks.
End with one sentence describing the business to an investor.
## 1. What They Sell and Who Buys
Describe the main products/services and target customers by type, segment, and geography.
## 2. How They Make Money
Explain revenue model, pricing logic, and whether revenues are recurring/one-time/hybrid.
Include key revenue segments if available. (Format: Plain text, no LaTeX/$)
## 3. Revenue Quality
Assess predictability and diversification. Break down recurring vs one-off, customer concentration, and cycle exposure.
## 4. Cost Structure
Analyze the specific cost components.
REQUIRED: Cite the exact % of revenue for:
- Cost of Revenue (COGS)
- R&D Expenses
- SG&A Expenses
If exact numbers are in the data, use them. Do not say "significant costs" - say "R&D was 1.2B USD (15% of rev)".
(Format: Plain text, no LaTeX/$)
## 5. Capital Intensity
Describe assets needed to run and grow. Include capex levels, working capital needs, and cash conversion efficiency.
(Format: Plain text, no LaTeX/$)
## 6. Growth Drivers
Identify main revenue growth levers (volume, pricing, product mix, geographic expansion, acquisitions).
Clarify whether each is structural/long-term or cyclical/short-term.
## 7. Competitive Edge
Explain what protects economics from competition (brand, cost advantage, switching costs, regulation, network effects, IP).
Discuss moat durability using financial evidence (margins, ROIC, retention).
## 8. Industry Structure and Position
Describe industry value chain and where profit pools sit.
Explain market structure (fragmented/consolidated, pricing power, regulation).
Place company within this context (market share, scale, price setter/taker).
## 9. Unit Economics and Key KPIs
**CRITICAL**: Unit economics are PER-UNIT metrics, not total company metrics.
**For B2C (Consumer) businesses:**
- ARPU (Average Revenue Per User) = Total Revenue √∑ Number of Customers (should be dollars per customer, NOT billions)
- For retail: Revenue per store, revenue per transaction, average ticket size
- CAC (Customer Acquisition Cost), LTV (Lifetime Value), churn rate
**For B2B (Enterprise) businesses:**
- ARPA (Average Revenue Per Account) = Total Revenue √∑ Number of Enterprise Customers
- Revenue per employee, revenue per contract, average contract value (ACV)
- Customer acquisition cost, net revenue retention, gross retention
**DO NOT report total revenue as ARPU/ARPA** - this is a fundamental error. These metrics require division by customer/account count.
If the data does not provide customer counts, account counts, transaction counts, or store-level metrics, state: "Unit economics data not available in filings. Would require operational metrics like customer count, account count, transaction volume, or store count."
Only report unit economics if you can calculate meaningful per-unit metrics. Otherwise, focus on company-level KPIs like same-store sales growth, net revenue retention, customer retention rates, or other operational metrics mentioned in the MD&A.
(Format: Plain text, no LaTeX/$)
## 10. Capital Allocation and Balance Sheet
Summarize historical capital allocation (organic investment, acquisitions, buybacks, dividends, debt reduction).
Describe balance sheet strength (leverage, debt maturity, liquidity).
Assess whether capital allocation has created or destroyed value.
(Format: Plain text, no LaTeX/$)
## 11. Risks and Failure Modes
Identify key risks (competitive, technological, regulatory, macro, customer concentration, currency).
Incorporate any negative sentiment from "RECENT FINANCIAL NEWS" and specific risks from the **LATEST 10-Q NARRATIVE**.
Describe how the equity story could fail and what would need to happen.
## 12. Valuation and Expected Return Profile
Compare current valuation with history and peers (P/E, EV/EBIT, EV/Sales, FCF yield).
Provide bear/base/bull scenario framework with rough assumptions and implied upside/downside.
State what must be true for current price to be attractive, fair, or expensive.
(Format: Plain text, no LaTeX/$)
## 13. Catalysts and Time Horizon
**IMPORTANT**: Do NOT use generic language like "product launches" or "margin inflection" without specifics.
List SPECIFIC, CONCRETE catalysts with details:
- Near-term (0-12 months): Mention specific products, earnings dates, contract renewals. Check "RECENT FINANCIAL NEWS" and **LATEST 10-Q** for immediate catalysts.
- Medium-term (1-3 years): Cite specific strategic initiatives, market expansions, or structural changes mentioned in filings.
- If no specific catalysts are mentioned in the data, state: "No specific near-term catalysts identified in available data."
(Format: Plain text, no LaTeX/$)
## 14. Year-over-Year 10-K Narrative Change
- **NO NUMBERS**. Do not cite revenue growth % or dollar changes.
- Focus ONLY on changes in language, strategy, tone, or risk factors.
- What is the management talking about now that they weren't before?
- What topics have disappeared?
## 15. Executive Compensation & Incentives
- Source: DEF 14A Filing (Proxy Statement)
- Explain the specific performance metrics used to determine CEO and CFO variable compensation (bonus/equity).
- **CRITICAL**: If 'Adjusted' metrics are used (e.g., Adjusted EBITDA, Non-GAAP Income), explicitly list WHAT is excluded.
- If Goodwill/Impairments are excluded, explicitly state: "Incentivized to make acquisitions regardless of subsequent performance."
- If Stock Based Compensation is excluded, explicitly state: "Incentivized to dilute shareholders."
"""
# ============================================================================
# SECTION 5: GEMINI API INTEGRATION
# ============================================================================
def analyze_with_gemini(context, ticker, api_key):
    """Use Google Gemini 1.5 Flash for massive-context analysis"""
    try:
        genai.configure(api_key=api_key)

        # Generation config
        generation_config = {
            "temperature": 0.1,
            "top_p": 0.95,
            "top_k": 64,
            "max_output_tokens": 8192,
            "response_mime_type": "text/plain",
        }
        prompt = f"""You are a Senior Financial Analyst. Analyze {ticker} using the data below.

        DATA:
        {context}

        {FRAMEWORK}

        CRITICAL ANALYSIS REQUIREMENTS:
        1. **CHECK DATA QUALITY NOTES FIRST** - If there are discrepancies flagged (e.g., debt/equity), use the CALCULATED/CORRECTED values.
        2. ALWAYS cite specific numbers from the data above.
        3. If a number is a ratio, use a percentage sign.
        4. Use actual figures.
        5. Be specific.
        6. **CONTEXT USAGE**: You have been provided with the FULL TEXT of the 10-K. Use this to find specific details, unit economics, and deep insights that other AIs might miss.
        7. Cross-reference Yahoo Finance data with SEC EDGAR data when both are present.
        8. **AVOID GENERIC BOILERPLATE**.
        """
        # Try multiple model names based on user's available models
        # Prioritize "latest" aliases which often map to stable production models with better quotas
        model_candidates = [
            "gemini-flash-latest",    # Production 1.5/2.0 Flash (Stable limits)
            "gemini-2.5-flash",       # High performance, 250k limit
            "gemini-2.0-flash",       # Standard 2.0
            "gemini-pro-latest",      # Production Pro
        ]

        last_error = None

        for model_name in model_candidates:
            try:
                print(f"   ü§ñ Trying model: {model_name}...")
                model = genai.GenerativeModel(
                    model_name=model_name,
                    generation_config=generation_config,
                    system_instruction="You are an expert financial analyst. NEGATIVE CONSTRAINT: Do NOT use LaTeX math formatting (e.g., $5.92B). Do NOT use the '$' character at all. ALWAYS use 'USD' suffix (e.g., '5.92B USD'). This is critical for display."
                )

                # Test connection / create chat
                chat_session = model.start_chat(history=[])

                print(f"      Generating analysis with {model_name}...")
                response = chat_session.send_message(prompt)
                return response.text

            except Exception as e:
                print(f"      ‚ö†Ô∏è  {model_name} failed: {e}")
                if "429" in str(e):
                    print("      ‚è≥ Rate limit hit. Waiting 10s before retry...")
                    time.sleep(10)
                last_error = e
                continue

        return f"‚ùå All Gemini models failed. Last error: {last_error}"
    except Exception as e:
        return f"‚ùå Gemini API error: {e}"
# ============================================================================
# SECTION 6: MAIN EXECUTION
# ============================================================================
def run_analysis():
    """Main function"""
    print("="*60)
    print("üìä FINANCIAL ANALYST AI - GEMINI POWERED (1M+ CONTEXT)")
    print("   Yahoo Finance + SEC EDGAR + Gemini 1.5 Flash")
    print("   ‚ö° Massive Context Window Analysis")
    print("="*60)

    # Validate API key
    if GEMINI_API_KEY == "xxxxxx" or not GEMINI_API_KEY:
        print("\n‚ùå ERROR: Please paste your Google Gemini API key at the top of the script!")
        print("   1. Get a free key at: https://aistudio.google.com/app/apikey")
        print("   2. Replace 'your-api-key-here' with your actual key")
        print("   3. Run the script again\n")
        return

    print(f"\n‚úÖ API key configured")

    # Get ticker
    ticker = input("\nüìà Enter stock ticker: ").upper().strip()
    if not ticker:
        print("‚ùå Ticker required")
        return

    # Fetch data
    context, error = get_comprehensive_data(ticker)
    if error:
        print(error)
        return

    # Generate analysis
    print(f"\n{'='*60}")
    print(f"üîç Analyzing {ticker}...")
    print(f"{'='*60}\n")

    analysis = analyze_with_gemini(context, ticker, GEMINI_API_KEY)

    # Display results
    print("\n" + "="*60)
    print(f"üìä ANALYSIS COMPLETE: {ticker}")
    print("="*60 + "\n")

    display(Markdown(analysis))

    # Save to file
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"{ticker}_analysis_{timestamp}.md"

    with open(filename, 'w', encoding='utf-8') as f:
        f.write(f"# Stock Analysis: {ticker}\n")
        f.write(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
        f.write(analysis)

    print(f"\nüíæ Saved to: {filename}")
    print("\n‚úÖ Analysis complete!")
# RUN IT
if __name__ == "__main__":
    run_analysis()

